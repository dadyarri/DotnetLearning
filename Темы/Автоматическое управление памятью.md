---
stage: 2
status: done
---
# Выделение памяти

При запуске процесса рантайм выделяет область памяти для него. Этот участок называется управялемой кучей. Эта управляемая куча содержит указатель на область памяти, в которой будет создан новый объект. Все [ссылочные типы](Reference%20типы) аллоцируются на куче. Когда создаётся первый объект ссылочного типа память под него выделяется в начале кучи. Каждый последующий объект создаётся сразу после предыдущего. Пока остаётся свободное пространство, сборщик мусора продолжает выделять память таким способом

Выделение памяти из управляемой кучи происходит быстрее, чем из неуправляемой памяти, так как рантайм выделяет память под объект добавляя значение к указателю, это практически так же быстро, как и выделение памяти на стеке. Кроме того, из-за того, что объекты распологаются в участке памяти подряд, приложение может получать доступ к объектам очень быстро.

# Высвобождение памяти

Алгоритмы оптимизации сборщика мусора (**GC**) автоматически определяют лучшее время для проведения сборки. Когда GC выполняет сборку, он освобождает память, выделенную под объекты, которые больше не используются приложением, полагась на корни.

У каждого приложения, есть набор корней. Корень - это объект на управялемой куче или null. Корни приложения включают в себя статические поля, локальные переменные, параметры на стеке потока и регистры процессора.

GC имеет доступ к списку активных корней, которые поддерживаются JIT и рантаймом. Используя этот список, создаётся граф, содержащий все объекты, доступные от корней.

Объекты, не попавшие в граф недостижимы из корней приложения. GC считает такие объекты мусором и освобождает память, выделенную под них. Во время сборки GC ищет блоки памяти, занятые неиспользуемыми объектами. При нахождении таких объектов, запускается копирование объектов, чтобы более компактно сложить используемые. После перекладывания объектов для более компактного использования памяти, GC поправляет ссылки на объекты в корнях приложения, чтобы они указывали на новое расположение объектов в памяти и перемещает указатель управляемой кучи после последнего объекта

Объекты перекладываются только если было найдено много неиспользуемых объектов. Если все объекты в памяти пережили сборку, перекладывание не происходит.

Для улучшения производительности, большие объекты (более ~83 КБ) складываются в отдельную кучу (Large Object Heap, LOH). Они сразу считаются Gen2 и редко куда-то перемещаются. [Подробнее про поколения памяти](Поколения%20памяти%20(Gen%200,%201,%202,%20LOH))